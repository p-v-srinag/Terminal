<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>⚡ Web Terminal Dashboard</title>
<style>
body {
  font-family: monospace;
  background: #0d1117;
  color: #c9d1d9;
  margin: 0; padding: 0;
}
#terminal {
  background: #010409;
  color: #e1ff00;
  padding: 10px;
  height: 500px;
  overflow-y: auto;
  white-space: pre-wrap;
  font-size: 14px;
  outline: none;
}
.prompt { color: #58a6ff; }
.cursor {
  display: inline-block;
  width: 8px;
  height: 16px;
  background: #e1ff00;
  animation: blink 1s step-start infinite;
}
@keyframes blink {
  50% { background: transparent; }
}
.suggestions { color:#58a6ff; font-size:12px; }
.editor, .game-area {
  background: #111;
  color: #0f0;
  padding: 5px;
  margin: 5px 0;
  border: 1px solid #444;
  height: 200px;
  overflow-y: auto;
  white-space: pre;
}
.selected { background: #444; }
</style>
</head>
<body>
<div id="terminal" tabindex="0"></div>

<script>
const terminal = document.getElementById("terminal");
let history = [];
let historyIndex = -1;
let currentCommand = "";
let cursorPos = 0;
let mode = "terminal"; // terminal | editor | game
let editorContent = "";
let gameMenuIndex = 0;
const commandsList = ["ls","cd","pwd","mkdir","rmdir","rm","touch","cat","echo","mv","cp","history","clear","sudo","pip install","python3","nano","vim","date","whoami","game"];

function newPrompt() {
  const line = document.createElement("div");
  line.classList.add("line");
  line.innerHTML = `<span class="prompt">$ </span><span class="current-command"></span><span class="cursor"></span><span class="suggestions"></span>`;
  terminal.appendChild(line);
  cursorPos = 0;
  scrollTerminal();
}
function scrollTerminal() { terminal.scrollTop = terminal.scrollHeight; }

function renderCommand() {
  const line = document.querySelector(".line:last-child");
  const cmdElem = line.querySelector(".current-command");
  const cursor = line.querySelector(".cursor");
  const left = currentCommand.slice(0, cursorPos);
  const right = currentCommand.slice(cursorPos);
  cmdElem.textContent = left;
  cmdElem.appendChild(cursor);
  cursor.insertAdjacentText("afterend", right);
}

// Fake local executor
async function executeCommand(cmd) {
  const line = document.querySelector(".line:last-child");
  line.querySelector(".cursor").remove();
  line.querySelector(".suggestions").remove();
  line.querySelector(".current-command").textContent = cmd;

  let output = "";
  if (cmd === "clear") {
    terminal.innerHTML = "";
    history.push(cmd);
    historyIndex = history.length;
    newPrompt();
    return;
  }
  else if (cmd === "history") {
    output = history.join("\n");
  }
  else if (cmd === "date") {
    output = new Date().toString();
  }
  else if (cmd === "whoami") {
    output = "guest@web-terminal";
  }
  else if (cmd.startsWith("nano") || cmd.startsWith("vim")) {
    startEditor();
    return;
  }
  else if (cmd === "game") {
    startGameMenu();
    return;
  }
  else {
    // backend
    const res = await fetch("/run", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({command:cmd})
    });
    const data = await res.json();
    output = data.output;
  }

  if (output) {
    const outDiv = document.createElement("div");
    outDiv.textContent = output;
    terminal.appendChild(outDiv);
  }

  if (cmd.trim()) history.push(cmd);
  historyIndex = history.length;
  newPrompt();
  currentCommand = "";
}

// Editor mode
function startEditor() {
  mode = "editor";
  const editor = document.createElement("div");
  editor.className = "editor";
  editor.textContent = editorContent;
  terminal.appendChild(editor);
  scrollTerminal();
}
function exitEditor() {
  mode = "terminal";
  const saveMsg = document.createElement("div");
  saveMsg.textContent = "[ File saved! ]";
  terminal.appendChild(saveMsg);
  editorContent = "";
  newPrompt();
}

// Game menu
function startGameMenu() {
  mode = "game";
  const gameDiv = document.createElement("div");
  gameDiv.className = "game-area";
  gameDiv.id = "gameMenu";
  gameDiv.innerHTML = renderGameMenu();
  terminal.appendChild(gameDiv);
  scrollTerminal();
}
function renderGameMenu() {
  const games = ["Snake","Tetris","2048"];
  return games.map((g,i)=> (i===gameMenuIndex?"> ":"  ")+g).join("\n");
}
function startSnake() {
  const snakeDiv = document.createElement("div");
  snakeDiv.className = "game-area";
  snakeDiv.textContent = "[ Snake game placeholder 🐍 ]";
  terminal.appendChild(snakeDiv);
  newPrompt();
  mode="terminal";
}

/* KEY HANDLING */
terminal.addEventListener("keydown", async (e)=>{
  if (mode==="editor") {
    if (e.key.length===1) editorContent += e.key;
    else if (e.key==="Backspace") editorContent=editorContent.slice(0,-1);
    else if (e.key==="Escape" || (e.ctrlKey && e.key==="s")) exitEditor();
    document.querySelector(".editor").textContent = editorContent;
    e.preventDefault(); return;
  }
  if (mode==="game") {
    if (e.key==="ArrowUp" && gameMenuIndex>0) gameMenuIndex--;
    if (e.key==="ArrowDown" && gameMenuIndex<2) gameMenuIndex++;
    if (e.key==="Enter") {
      if (gameMenuIndex===0) startSnake();
      else {
        const div = document.createElement("div");
        div.className="game-area";
        div.textContent="[ Game not implemented yet ]";
        terminal.appendChild(div);
        newPrompt();
        mode="terminal";
      }
    }
    document.getElementById("gameMenu").textContent = renderGameMenu();
    e.preventDefault(); return;
  }

  e.preventDefault();
  if(e.key.length===1){ 
    currentCommand = currentCommand.slice(0,cursorPos)+e.key+currentCommand.slice(cursorPos);
    cursorPos++; 
  }
  else if(e.key==="Backspace" && cursorPos>0){ 
    currentCommand = currentCommand.slice(0,cursorPos-1)+currentCommand.slice(cursorPos); 
    cursorPos--; 
  }
  else if(e.key==="ArrowLeft" && cursorPos>0){ cursorPos--; }
  else if(e.key==="ArrowRight" && cursorPos<currentCommand.length){ cursorPos++; }
  else if(e.key==="Enter"){ await executeCommand(currentCommand); }
  else if(e.key==="ArrowUp"){ if(historyIndex>0){ historyIndex--; currentCommand=history[historyIndex]; cursorPos=currentCommand.length; } }
  else if(e.key==="ArrowDown"){ if(historyIndex<history.length-1){ historyIndex++; currentCommand=history[historyIndex]; cursorPos=currentCommand.length; } else { historyIndex=history.length; currentCommand=""; cursorPos=0; } }

  renderCommand();
});

newPrompt();
terminal.focus();
terminal.addEventListener("click",()=>terminal.focus());
</script>
</body>
</html>
